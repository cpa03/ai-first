name: oc - Issue Solver

on:
  issues:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  issues_solver:
    name: OC issues solver
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Issues Solver
        id: run_issues_solver
        run: |
          opencode run "$(cat <<'PROMPT'
            Tugas Anda:
            1. List semua issue, pilih 1 issue paling penting.
            2. Komentar di halaman issue rencana untuk solve issue
            3. Solve issue dengan perubahan minimal
            4. Pastikan build berhasil
            5. Buat pr dengan link ke issue yang diselesaikan dan deskripsi yang jelas dan komprehensif, jika ada gunakan template pr
            6. Baca agent-report.md, Buat catatan di agent-report.md sesuai format
            Instruksi:
            1. Gunakan github cli dengan GH_TOKEN
            2. Jika gagal membuat pr karena permission error, maka ulangi langkah 1 dengan memilih issue yang berbeda
            3. Belajar dari seluruh proses dan jangan ulangi kesalahan
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            --token ${{ secrets.GH_TOKEN }} \
