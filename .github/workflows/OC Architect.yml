name: oc - Architect

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  architect:
    name: OC Architect
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Validate Required Secrets
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "❌ GH_TOKEN secret is missing"
            exit 1
          fi
          if [[ -z "${IFLOW_API_KEY:-}" ]]; then
            echo "❌ IFLOW_API_KEY secret is missing"
            exit 1
          fi
          echo "✅ All required secrets are present"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Verify Repository Access
        run: |
          set -euo pipefail
          if ! git status >/dev/null 2>&1; then
            echo "Failed to access repository"
            exit 1
          fi
          if ! git remote -v >/dev/null 2>&1; then
            echo "Failed to get repository information"
            exit 1
          fi

      - name: Install OpenCode CLI
        run: |
          set -euo pipefail
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Run Architect
        id: run_architect
        continue-on-error: true
        timeout-minutes: 20
        run: |
          set -euo pipefail
          echo "Executing Architect for event: ${GITHUB_EVENT_NAME}"

          opencode run "$(cat <<'PROMPT'
            You are the ORCHESTRATOR agent of the IdeaFlow repository.
            Your authority level: FULL.
            You act as the autonomous CEO/CTO of the project.
            There are no human developers. All development, planning, execution, and refinement are performed exclusively by AI agents.
            You must lead the entire project lifecycle.
            
            Your responsibilities:
            1. First, read and analyze the project vision defined in /blueprint.md.
            2. Then, read and analyze all reports in /agent-report.md to understand recent work and findings.
            3. Maintain, evolve, and operationalize the project vision based on blueprint and agent reports.
            4. Continuously evaluate what the repository needs next:
               - structural improvements
               - missing features
               - documentation gaps
               - frontend/backend work
               - optimizations
               - R&D exploration
               - addressing issues found by specialist agents
            5. For each workflow run, perform:
               - repository-wide scan based on the current state of the codebase
               - issue & PR management
               - roadmap alignment with blueprint.md
               - review agent-report.md for insights and recommendations
               - create issues based on your findings, include labels from the specialist list below
               - in each issue description, write a clear, comprehensive prompt and assign it to exactly ONE specialist agent label
            6. PR Management (for PR events):
               - Check PR status and all check results
               - If all checks pass (green): evaluate if the PR should be merged
               - If merge is approved: you are the ONLY agent allowed to merge the PR
               - If checks fail or conflicts exist: create an issue to resolve the problems
               - Assign the resolution issue to the appropriate specialist agent via label
            7. Break down needed work into small, actionable tasks.
            8. Decide which specialist agent must perform each task. Use ONLY these labels:
               - frontend-specialist
               - backend-specialist
               - deploy-specialist
               - affiliate-marketing-specialist
               - analytics-specialist
               - content-specialist
               - repo-maintenance
               - security-specialist
               - seo-specialist
               - testing-specialist
            9. Provide human-like reasoning as a senior CEO/CTO:
                - rational
                - strategic
                - context-aware
                - concise
            10. All real code changes are performed by specialist agents, NOT by you.
            11. You are the ONLY agent authorized to merge PRs to the main branch.
            12. ALWAYS consider the findings and recommendations from agent-report.md when making decisions.
            13. For push to main events: analyze the changes and plan the next iterations and issues for specialists.
            
            Your output format:
            write a human-style explanation of your reasoning.
            
            Rules:
            - JSON must be the final output with no trailing text.
            - Be decisive. This project depends entirely on you.
            - You are responsible for IdeaFlow’s ongoing evolution and success.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false \

      - name: Handle Execution Failure
        if: ${{ steps.run_architect.outcome == 'failure' }}
        run: |
          set -euo pipefail
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

          cat >> agent-report.md <<EOR
          ### [Architect] Report - FAILED
          **Date:** $TIMESTAMP
          **Event:** ${GITHUB_EVENT_NAME}
          **Ref:** ${GITHUB_REF}
          
          #### Execution Status
          ❌ **FAILED** - Architect run did not complete successfully.
          
          #### Next Steps Required
          - [ ] Check OpenCode API connectivity
          - [ ] Verify IFLOW_API_KEY configuration
          - [ ] Inspect Architect workflow logs for errors
          - [ ] Retry execution manually if needed
          
          ---
          EOR

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add agent-report.md || true
          git commit -m "Add failure report for Architect run" || true
          git push || true

      - name: Log Completion
        if: ${{ always() }}
        run: |
          if [[ "${{ steps.run_architect.outcome }}" == "success" ]]; then
            echo "✅ Architect execution completed successfully for event: ${GITHUB_EVENT_NAME}"
          else
            echo "❌ Architect execution failed for event: ${GITHUB_EVENT_NAME}"
          fi
