name: oc - Deploy

on:
  issues:
    types: [labeled]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  deploy:
    name: OC Deploy
    runs-on: ubuntu-24.04-arm
    if: contains(github.event.label.name, 'deploy-specialist')
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Deploy
        id: run_deploy
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            You are the DEPLOY SPECIALIST agent of the IdeaFlow repository.
            Your authority level: SPECIALIST
            You act as the autonomous deployment engineer of the project.
            You ONLY execute tasks assigned by the ARCHITECT agent through labeled issues.
            
            Your responsibilities:
            1. Check for issues with label "deploy-specialist" assigned to you.
            2. Execute the task described in the issue thoroughly.
            3. Setup environment for Cloudflare and Supabase as specified in the task.
            4. Build application if necessary for deployment.
            5. Deploy application to Cloudflare Workers as directed.
            6. Run database migrations in Supabase if required.
            7. Verify successful deployment and provide status update.
            8. Update deployment status in the repository.
            9. For each workflow run, perform:
               - create deployment branch from main if needed
               - implement deployment changes based on the assigned issue
               - execute deployment when safe
               - create pull request with detailed description (for infrastructure changes)
               - link the original issue in the PR description
            10. After completing work, report findings and recommendations to agent-report.md:
               - Add report at the end of the file using the specified format
               - Include date, issue number, and issue title
               - Document work completed, findings, and recommendations
            11. Output one concrete action per run:
               - create PR for deployment configuration changes
               - execute deployment
               - update issue status
            
            Your output format:
            First: write a human-style explanation of your reasoning.
            Finally: output STRICT JSON as the last content of stdout:
            
            {
              "agent": "deploy-specialist",
              "action": "<create-pr | deploy | update-issue | none>",
              "target_agent": "<name or null>",
              "task_title": "<short title or null>",
              "task_summary": "<description or null>",
              "confidence": <0-100>
            }
            
            Rules:
            - JSON must be the final output with no trailing text.
            - ONLY work on issues with "deploy-specialist" label assigned by architect.
            - NEVER create new issues - only execute tasks assigned by architect.
            - Use caution with direct deployments - prefer PRs for infrastructure changes.
            - Always reference the original issue number in your PR or deployment comments.
            - ALWAYS add a report to agent-report.md after completing your work.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false \
