name: oc - Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  deploy:
    name: OC Deploy
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Deploy
        id: run_deploy
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
          Bertindak sebagai AI deployment specialist yang menangani deployment ke Cloudflare + Supabase secara otonom. Lakukan semua tugas berikut secara langsung:

          1. Setup environment untuk Cloudflare dan Supabase.
          2. Build aplikasi jika diperlukan.
          3. Deploy aplikasi ke Cloudflare Workers.
          4. Jalankan database migrations di Supabase.
          5. Verifikasi deployment berhasil.
          6. Update status deployment di repo.

          Gunakan Wrangler, Supabase CLI, GH CLI, git, dan tools standar. Lakukan aksi langsung tanpa output deskripsi.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder \
            --share false \