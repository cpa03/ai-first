name: oc - Unified Specialists

on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  validate-label:
    name: Scan Open Issues and Match Labels
    runs-on: ubuntu-24.04-arm
    outputs:
      issue_number: ${{ steps.scan.outputs.issue_number }}
      issue_label: ${{ steps.scan.outputs.issue_label }}

    steps:
      - name: Install gh and jq
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          gh --version
          jq --version

      - name: Scan open issues and match labels
        id: scan
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          VALID_LABELS=(
            "frontend-specialist"
            "backend-specialist"
            "testing-specialist"
            "security-specialist"
            "seo-specialist"
            "content-specialist"
            "repo-maintenance"
            "deploy-specialist"
            "analytics-specialist"
            "affiliate-marketing-specialist"
          )

          MATCHED_NUMBER=""
          MATCHED_LABEL=""

          ISSUES=$(gh api repos/"$REPO"/issues \
            --paginate \
            --jq '.[] | select(.state=="open" and (.pull_request | not)) | {number, labels: [.labels[].name]}')

          if [[ -n "$ISSUES" ]]; then
            while IFS= read -r ISSUE; do
              NUMBER=$(jq -r '.number' <<<"$ISSUE")
              LABELS=$(jq -r '.labels[]' <<<"$ISSUE" || true)

              for L in $LABELS; do
                for V in "${VALID_LABELS[@]}"; do
                  if [[ "$L" == "$V" ]]; then
                    MATCHED_NUMBER="$NUMBER"
                    MATCHED_LABEL="$L"
                    break 3
                  fi
                done
              done
            done <<<"$ISSUES"
          fi

          echo "Matched issue: ${MATCHED_NUMBER:-<none>} with label: ${MATCHED_LABEL:-<none>}"
          echo "issue_number=$MATCHED_NUMBER" >> "$GITHUB_OUTPUT"
          echo "issue_label=$MATCHED_LABEL"  >> "$GITHUB_OUTPUT"

      - name: Print scan result
        run: |
          echo "Matched issue: ${{ steps.scan.outputs.issue_number }} / ${{ steps.scan.outputs.issue_label }}"

  specialist:
    name: OC ${{ matrix.specialist.display_name }}
    needs: validate-label
    # Hanya jalan kalau memang ada issue yang terpilih
    if: ${{ needs.validate-label.outputs.issue_number != '' }}
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40

    strategy:
      fail-fast: false
      matrix:
        specialist:
          - name: "frontend"
            display_name: "Frontend Specialist"
            condition: "frontend-specialist"
            role: "FRONTEND SPECIALIST"
            description: "autonomous frontend developer"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Analyze frontend code and identify areas for improvement (UI/UX, performance, accessibility)"
              - "Implement new features or improvements based on frontend best practices"
              - "Optimize code for efficiency and loading speed"
              - "Ensure responsive design and cross-browser compatibility"
              - "Update styling and components for modern standards"
              - "Run linting and automatic formatting for changes"
          - name: "backend"
            display_name: "Backend Specialist"
            condition: "backend-specialist"
            role: "BACKEND SPECIALIST"
            description: "autonomous backend developer"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Analyze backend code and identify bugs or inefficiencies"
              - "Implement or improve API endpoints as specified"
              - "Optimize database queries and schema as needed"
              - "Ensure security best practices (authentication, authorization, input validation)"
              - "Implement caching and performance optimizations"
              - "Update API documentation for changes"
          - name: "testing"
            display_name: "Testing Specialist"
            condition: "testing-specialist"
            role: "TESTING SPECIALIST"
            description: "autonomous testing engineer"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Run unit tests, integration tests, and e2e tests for assigned tasks"
              - "Test cross-browser compatibility based on task requirements"
              - "Test performance and load times as part of task execution"
              - "Validate HTML, CSS, and accessibility for the task"
              - "Generate test reports and fix failures as needed"
          - name: "security"
            display_name: "Security Specialist"
            condition: "security-specialist"
            role: "SECURITY SPECIALIST"
            description: "autonomous security engineer"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Scan vulnerabilities in code and dependencies for assigned tasks"
              - "Implement security headers and CSP as required"
              - "Encrypt sensitive data like affiliate IDs as part of task execution"
              - "Audit authentication and authorization systems based on task requirements"
              - "Monitor for breaches or suspicious activity related to the task"
              - "Update security policies and documentation as needed"
          - name: "seo"
            display_name: "SEO Specialist"
            condition: "seo-specialist"
            role: "SEO SPECIALIST"
            description: "autonomous SEO expert"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Analyze meta tags, headings, and HTML structure for assigned tasks"
              - "Optimize title, description, and keywords for affiliate products as specified"
              - "Fix broken links and internal linking based on task requirements"
              - "Implement schema markup for products as part of task execution"
              - "Optimize images with alt text and compression as needed"
              - "Generate sitemap and submit to search engines for the task"
          - name: "content"
            display_name: "Content Specialist"
            condition: "content-specialist"
            role: "CONTENT SPECIALIST"
            description: "autonomous content manager"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Generate compelling and SEO-friendly product descriptions for assigned tasks"
              - "Create blog posts or articles about affiliate products as specified"
              - "Update existing content with latest information based on task requirements"
              - "Optimize copywriting for conversion as part of task execution"
              - "Translate content to other languages if needed for the task"
          - name: "repo-maintenance"
            display_name: "Repo Maintenance"
            condition: "repo-maintenance"
            role: "REPO MAINTENANCE"
            description: "autonomous repository maintainer"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Analyze code and fix efficiency, security, and maintainability issues for assigned tasks"
              - "Update dependencies if there are new safe versions as part of task execution"
              - "Run security scans and fix vulnerabilities as required"
              - "Clean up unnecessary or duplicate files based on task requirements"
              - "Update README documentation or comments if lacking for the task"
          - name: "deploy"
            display_name: "Deploy Specialist"
            condition: "deploy-specialist"
            role: "DEPLOY SPECIALIST"
            description: "autonomous deployment engineer"
            actions: "create-pr | deploy | update-issue | none"
            responsibilities:
              - "Setup environment for Cloudflare and Supabase as specified in the task"
              - "Build application if necessary for deployment"
              - "Deploy application to Cloudflare Workers as directed"
              - "Run database migrations in Supabase if required"
              - "Verify successful deployment and provide status update"
              - "Update deployment status in the repository"
          - name: "analytics"
            display_name: "Analytics Specialist"
            condition: "analytics-specialist"
            role: "ANALYTICS SPECIALIST"
            description: "autonomous data analyst"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Analyze traffic, conversion rates, and affiliate earnings for assigned tasks"
              - "Generate weekly/monthly reports as needed"
              - "Identify trends and insights based on task requirements"
              - "Suggest improvements based on data analysis"
              - "Setup or update tracking pixels and scripts as required"
              - "Monitor A/B tests for affiliate links as part of task execution"
          - name: "affiliate-marketing"
            display_name: "Affiliate Marketing Specialist"
            condition: "affiliate-marketing-specialist"
            role: "AFFILIATE MARKETING SPECIALIST"
            description: "autonomous affiliate marketing manager"
            actions: "create-pr | update-issue | none"
            responsibilities:
              - "Analyze affiliate link performance and conversions for assigned tasks"
              - "Update affiliate links if there are changes from the platform"
              - "Optimize product placement to increase CTR based on task requirements"
              - "Generate affiliate earnings reports as needed"
              - "Suggest new products to add as part of task execution"
              - "Update marketing strategy based on data analysis"

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      SPECIALIST_NAME: ${{ matrix.specialist.name }}
      SPECIALIST_ROLE: ${{ matrix.specialist.role }}
      SPECIALIST_DESCRIPTION: ${{ matrix.specialist.description }}
      SPECIALIST_ACTIONS: ${{ matrix.specialist.actions }}
      ISSUE_NUMBER: ${{ needs.validate-label.outputs.issue_number }}
      ISSUE_LABEL: ${{ needs.validate-label.outputs.issue_label }}

    steps:
      - name: Guard â€“ check if this specialist matches label
        id: guard
        run: |
          if [[ "${ISSUE_LABEL}" == "${{ matrix.specialist.condition }}" ]]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Log Specialist Information
        if: ${{ steps.guard.outputs.run == 'true' }}
        run: |
          echo "ðŸš€ Running ${{ matrix.specialist.display_name }}"
          echo "ðŸ“‹ Issue: #${ISSUE_NUMBER}"
          echo "ðŸ·ï¸ Label: ${ISSUE_LABEL}"

      - name: Validate Required Secrets
        if: ${{ steps.guard.outputs.run == 'true' }}
        run: |
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "âŒ GH_TOKEN secret is missing"
            exit 1
          fi
          if [[ -z "${IFLOW_API_KEY:-}" ]]; then
            echo "âŒ IFLOW_API_KEY secret is missing"
            exit 1
          fi
          echo "âœ… All required secrets are present"

      - name: Checkout
        if: ${{ steps.guard.outputs.run == 'true' }}
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Verify Repository Access
        if: ${{ steps.guard.outputs.run == 'true' }}
        run: |
          if ! git status >/dev/null 2>&1; then
            echo "Failed to access repository"
            exit 1
          fi
          if ! git remote -v >/dev/null 2>&1; then
            echo "Failed to get repository information"
            exit 1
          fi

      - name: Install OpenCode CLI
        if: ${{ steps.guard.outputs.run == 'true' }}
        run: |
          set -euo pipefail
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Generate Dynamic Prompt
        if: ${{ steps.guard.outputs.run == 'true' }}
        id: generate_prompt
        run: |
          set -euo pipefail

          RESP_JSON='${{ toJson(matrix.specialist.responsibilities) }}'
          RESPONSIBILITIES_LIST=$(python3 - <<'PY'
          import json, sys
          arr = json.loads(sys.stdin.read() or "[]")
          for i, item in enumerate(arr, start=1):
              print(f"  {i}. {item}")
          PY
          <<<"$RESP_JSON")

          TITLE=$(gh api repos/${{ github.repository }}/issues/"$ISSUE_NUMBER" --jq '.title' 2>/dev/null || echo "")
          BODY=$(gh api repos/${{ github.repository }}/issues/"$ISSUE_NUMBER" --jq '.body' 2>/dev/null || echo "")

          cat > /tmp/specialist_prompt.txt <<PROMPT
          You are the ${SPECIALIST_ROLE} agent of the IdeaFlow repository.
          Your authority level: SPECIALIST
          You act as the ${SPECIALIST_DESCRIPTION} of the project.
          You ONLY execute tasks assigned by the ARCHITECT agent through labeled issues.

          Current Issue Information:
          - Issue Number: ${ISSUE_NUMBER}
          - Issue Title: ${TITLE}
          - Issue Body: ${BODY}
          - Assigned Label: ${ISSUE_LABEL}

          Your responsibilities:
          ${RESPONSIBILITIES_LIST}
          10. For each workflow run, perform:
             - create feature branch from main
             - implement changes based on the assigned issue
             - create pull request with detailed description
             - link the original issue in the PR description
          11. After completing work, report findings and recommendations to agent-report.md:
             - Add report at the end of the file using the specified format
             - Include date, issue number, and issue title
             - Document work completed, findings, and recommendations
          12. Output one concrete action per run:
             - create PR for implemented changes
             - update issue status

          Your output format:
          First: write a human-style explanation of your reasoning.
          Finally: output STRICT JSON as the last content of stdout:

          {
            "agent": "${{ matrix.specialist.name }}-specialist",
            "action": "<${{ matrix.specialist.actions }}>",
            "target_agent": "<name or null>",
            "task_title": "<short title or null>",
            "task_summary": "<description or null>",
            "confidence": <0-100>
          }

          Rules:
          - JSON must be the final output with no trailing text.
          - ONLY work on issues with "${{ matrix.specialist.condition }}" label assigned by architect.
          - NEVER create new issues - only execute tasks assigned by architect.
          - NEVER push to main. All implementations must be executed through branches and PRs.
          - Always reference the original issue number in your PR.
          - ALWAYS add a report to agent-report.md after completing your work.
          PROMPT

          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          cat /tmp/specialist_prompt.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Run ${{ matrix.specialist.display_name }}
        if: ${{ steps.guard.outputs.run == 'true' }}
        id: run_specialist
        continue-on-error: true
        timeout-minutes: 20
        run: |
          set -euo pipefail
          echo "Executing specialist for issue #${ISSUE_NUMBER}"
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT+1))"
            if opencode run "$(cat /tmp/specialist_prompt.txt)" --model iflowcn/glm-4.6 --share false; then
              echo "success=true" >> "$GITHUB_OUTPUT"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 30
              else
                echo "success=false" >> "$GITHUB_OUTPUT"
                exit 1
              fi
            fi
          done

      - name: Handle Execution Failure
        if: ${{ steps.guard.outputs.run == 'true' && (steps.run_specialist.outcome == 'failure' || steps.run_specialist.outputs.success == 'false') }}
        run: |
          set -euo pipefail
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          cat >> agent-report.md <<EOR
          ### [${{ matrix.specialist.display_name }}] Report - FAILED
          **Date:** $TIMESTAMP
          **Issue:** #${ISSUE_NUMBER}
          **Label:** ${ISSUE_LABEL}

          #### Execution Status
          âŒ **FAILED** - Could not complete assigned task

          #### Error Details
          - Specialist: ${{ matrix.specialist.display_name }}
          - Issue Number: ${ISSUE_NUMBER}
          - Attempts Made: 3 (with 30-second intervals)
          - Last Attempt: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          #### Next Steps Required
          - [ ] Manual review of the issue requirements
          - [ ] Check OpenCode API connectivity
          - [ ] Verify IFLOW_API_KEY configuration
          - [ ] Retry execution manually if needed

          ---
          EOR

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add agent-report.md || true
          git commit -m "Add failure report for ${{ matrix.specialist.name }} - Issue #${ISSUE_NUMBER}" || true
          git push || true

      - name: Log Completion
        if: ${{ steps.guard.outputs.run == 'true' && always() }}
        run: |
          if [[ "${{ steps.run_specialist.outputs.success }}" == "true" ]]; then
            echo "âœ… ${{ matrix.specialist.display_name }} execution completed successfully for #${ISSUE_NUMBER}"
          else
            echo "âŒ ${{ matrix.specialist.display_name }} execution failed for #${ISSUE_NUMBER}"
          fi
